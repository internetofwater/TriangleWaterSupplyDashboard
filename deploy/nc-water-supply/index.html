<!doctype html>
<!-- (c) Copyright protected by Duke University -->
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Water Supply Status</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.png">

    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/styleInfo.css">

    <script  src="https://code.jquery.com/jquery-3.5.0.min.js"  integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ="
    crossorigin="anonymous"></script>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css"
        type="text/css"/>

    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
      <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
    
    <script src="https://d3js.org/d3.v5.min.js"></script>           
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/geojson-vt@3.2.0/geojson-vt.js"></script> <!-- create mapbox vector tiles-->

    <style type="text/css">
      .nav-pills { 
        font-size: 16px; 
        text-align: center; 
      }
      .nav-pills > li {
        border-radius: 4px 4px 0 0;
        display: inline-block;
        float: none;
        min-width: 110px;
        zoom: 1;
      }
    
      .nav-pills > li.active > a,
      .nav-pills > li.active > a:hover,
      .nav-pills > li.active > a:focus{
          background-color: #5D6D7E;  
          color: #AED6F1;
          }
  
      .btn {
            background: rgb(200,200,200);
            border: 1px solid rgba(0, 0, 0, 0.4);
            border-radius: 3px;
            font-size: 13px;
            height: 40px;
            line-height: 90%;
            /*min-width: 100px;*/
            margin-top: 2px;
            padding: 3px;
            text-align: center;
            vertical-align: middle;
            width: 90px;
            white-space: normal; /*breaks text to wrap*/
        }

        .forecast{
          background: repeating-linear-gradient(
            45deg, 
            rgb(230,230,230),
            rgb(230,230,230) 10px,
            rgb(200,200,200) 10px,
            rgb(200,200,200) 20px
            );
        }

        p { font-family: verdana;
            font-size: 14px; 
          }
      
      .geocoder {
        position: absolute;
        z-index: 1;
        width: 50%;
        left: 50%;
      }
      .mapboxgl-ctrl-geocoder {
        min-width: 90%;
      }

      .mapboxgl-popup{
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        max-width: 400px;
      }

        .legend {
          background-color: rgba(255,255,255,0.8);
          border-radius: 3px;
          bottom: 5px;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
          font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
          padding: 5px;
          position: absolute;
          right: 10px;
          z-index: 100;
        }
        .legend h4 { margin: 0 0 10px; }
 
        .legend div span {
          border-radius: 50%;
          display: inline-block;
          height: 10px;
          margin-right: 5px;
          /*width: 10px;*/
         }

         .table > tbody > tr > td { vertical-align: middle;}

         .my-custom-scrollbar {
            position: relative;
            height: 350px;
            overflow: auto;
           }
          .my-custom-scrollbar thead th {background: white; position: sticky; top: 0; }
         .table-wrapper-scroll-y{ display: block; }

         ul{ padding-left: 12px; }

   
       select {text-align-last:center; }
       body {overflow-x: hidden;}  /*gets rid of the horizontal scroll bar at the bottom
    </style>
</head>

<body>
<div class="row" style="text-align: left; margin-top: 0px; margin-bottom: 0px; padding-bottom: -10px;">
    <div class="col-sm-9">    
        <h1 style="padding-left: 1em; color: #02145C">Triangle Water Supply</h1>    
        <hr style="background-color: #02145C; height: 5px;">
    </div>
    <div class="col-sm-3" id="footer">
        <a href = "https://internetofwater.org/"> <img src="img/iow_logo.png" style="width: 200px; height: 78px; display: inline-block"> </a> 
    </div> 
</div>

<!-- EXPLANATION TAB #################################################################################################

####################################################################################################################-->
<div class="row" style="text-align: left, margin-top: -10px; margin-left: 10px; margin-bottom: 0px; margin-right: 10px;">
    <p style="color: rgb(43,28,88);"><em><strong>Disclaimer:</strong> We are in the process of building this tool and are actively making modifications. All data and analysis are provisional. This tool is best viewed in Chrome, Firefox, Microsoft Edge, and Safari. It does not work with Internet Explorer. Please allow the dashboard to fully load.</em></p>
    <br>
    
    <!--h4 style= "color: black;"><b>Introductory Text:</b></h4-->
    <form name="selectSystem" style="font-size: 18px; font-family: Arial; color: rgb(26,131,130);"> 
        <span style="color: #cc0000; font-size: 18px; margin-left: 10px;"><strong>Select a utility on the map, in the drop down menu, or by typing in an address:  </strong></span> &nbsp;
      <select style="width: 320px;" name="setSystem" id="setSystem" onchange="setSystemThis(this);">
              <option selected = "selected" value="none"> Select a Utility </option>
      </select>  
  </form>

</div>


<!--#######################################################################################################
                                    TAB SET UP
    ######################################################################################################-->
<div class="container" style="padding-top: 20px; margin-left: 5px; margin-right: 5px; display: flex; width: 100%;" >
  <div class="col-sm-6" style = "text-align: center;">   
  <div class="row" id = "map-layers-row" style = "text-align: center; background-color: rgba(240,240,240); border: thin solid rgb(26,131,130); margin-right: 4px;">
      <div class="row">  <h4 style="color: rgb(26,131,130); text-align: center;"><strong>Turn Map Layers On and Off</strong></h4> </div>
        <div class="row" style="text-align: center; margin-bottom: 2px;"> 
          <div style="display: inline-block;">
            <button class = "btn" value = "menuUtility" id = "menuUtility" style= "background-color: #3f97a8; color: white;"><strong>Utility</strong></button>
          </div>
          <div style="display: inline-block;">
            <button class = "btn" value = "menuCounty" id = "menuCounty"><strong>County</strong></button>
          </div>
          <div style="display: inline-block;"> 
            <button class="btn" value="menuBasins" id="menuBasins"><strong>River Basin</strong></button>
          </div>
          <div style="display: inline-block;">
             <button class="btn" value="menuWatershed" id="menuWatershed"><strong>Sub-Basin</strong></button>
          </div>
          <div style="display: inline-block;"> 
            <button class = "btn" value = "menuSource" id = "menuSource"><strong>Water Source</strong></button>
          </div>
          <div style="display: inline-block;"> 
            <button class = "btn" value = "menuRivers" id = "menuRivers"><strong>Rivers</strong></button>
          </div>
          
          <div style="display: inline-block;"> 
            <button class = "btn" value = "menuStreamGages" id = "menuStreamGages"><strong>Stream Gages</strong></button>
          </div>
          <div style="display: inline-block;"> 
            <button class = "btn" value = "menuReservoirs" id = "menuReservoirs"><strong>Reservoirs</strong></button>
          </div>
          <div style="display: inline-block;"> 
             <button class = "btn" value = "menuGroundwater" id = "menuGroundwater"><strong>Wells</strong></button>
          </div>

          <div style="display: inline-block;"> 
            <button class = "btn" value = "menuPrecipitation" id = "menuPrecipitation"><strong>Weather Stations</strong></button>
          </div>
          <div style="display: inline-block;"> 
              <button class = "btn" value = "menuDrought" id = "menuDrought"><strong>Drought</strong></button>
          </div>
          <div style="display: inline-block;"> 
            <button class = "btn" value = "menuPCP7DayObsv" id = "menuPCP7DayObsv"><strong>Precip 7-day Observ</strong></button>
          </div>
          <div style="display: inline-block;"> 
            <button class = "btn" value = "menuPCP7DayNorm" id = "menuPCP7DayNorm"><strong>Precip 7-day %Normal</strong></button>
          </div>
          <div style="display: inline-block;">
            <button class = "btn forecast" value = "menuQPF7day" id = "menuQPF7day"><strong>QPF 7-day Forecast</strong></button>
          </div>
          <div style="display: inline-block;">
            <button class = "btn forecast" value = "menuForecastPCP6" id = "menuForecastPCP6"><strong>Precip 6-10 Day Forecast</strong></button>
          </div> 
          <div style="display: inline-block;"> 
            <button class = "btn forecast" value = "menuForecastTEMP6" id = "menuForecastTEMP6"><strong>Temp 6-10 Day Forecast</strong></button>
        </div>
    </div><!--end top row-->
  </div><!-- end row for map layers-->



  </div> <!--creates space for map-->

  <div class="col-sm-6" style = "padding-bottom: 2px; border-bottom: 2px solid #5D6D7E;">
    <div class="row" style="text-align: center; color: rgb(26,131,130)"><h4>Data Updated: January 8, 2021</h4></div>

 <script>//LOAD DROP DOWN LIST
  document.getElementById("setSystem").options.length = 1;
  opts = document.getElementById('setSystem');

  d3.csv("data/basic_info.csv").then(function(dataCSV){
  var systemList = dataCSV.filter(function(d) { return d.data === "yes"; });
  var systemNames = systemList.map(function(d){ return d.utility_name; });
  systemList.sort(function (a,b) {
     return (a.utility_name < b.utilty_name) ? -1 : 1;
  });
  for(i=0; i< systemNames.length; i++) {
         var option = document.createElement('option');
            option.text = systemList[i].utility_name;
            option.value = systemList[i].pwsid;
            opts.appendChild(option);
  }
  opts.value = myUtility;
});//end d3

function setSystemThis(target){
  var sel = document.getElementById('setSystem');
    myUtilityID = sel.value;
    myUtility = sel.options[sel.selectedIndex].text;

    if (myUtilityID === "none"){
      myUtility = "none";
      myUtilityInfo(myUtility);
      createBlankSummary();
    }
    if (myUtilityID !== "none"){
      myUtilityInfo(myUtility);
      createCurrentSummary(myUtility);
      createDemandInfo(myUtilityID, checkedDemand);
    }
   
    return {myUtility, myUtilityID};
 }

</script>


    <div class="row">
    <ul id="tabs" class="nav nav-pills" data-tabs="tabs" style="position: absolute; bottom: 0;">
        <li class = "active"><a href="#about" data-toggle="tab">My <br> Utility</a></li>
        <li><a href="#demand" data-toggle="tab">Demand <br> Data</a></li>
        <li><a href="#waterSupplyStatus" data-toggle="tab">Surface <br> Water</a></li>
        <li><a href="#pcpDrought" data-toggle="tab">Rain &<br>Drought</a></li>
        <li><a href="#groundwater" data-toggle="tab">Ground-<br>water</a></li>
      </ul>
    </div>
  </div> <!--End Div for Tabs-->
</div> <!-- end row div -->


<!--#######################################################################################################
                                    MAP DIV
    ######################################################################################################-->
<div class="row" id = "main-one" style="margin-left: 5px; margin-right: 5px; margin-bottom: 20px;">
  <div class="col-sm-6" id = "map-column" style="z-index: 1px;"> 
   <div class = "row" style="margin-left: 4px; margin-right: 0px; border: thin solid rgb(26,131,130); z-index: 2px;">
      <div id="map" style="height: 600px;"> <!--border: thin solid black;"--> 
      <div class="infoMap" id="map_hover_box"><p><strong>Hover over utilities</strong></p></div>
      <div class="legend" id="stream-legend" style="display: none;"></div>    
      <div class="legend" id="drought-legend" style="display: none;"></div>    
    </div> <!--end map Div-->
  </div><!--end map row div-->

  </div><!--end col-sm-6 .... ### HAD TO SEPARATE TO FIX OFFSET. https://github.com/mapbox/mapbox-gl-js/issues/9467-->
  

  <!--#####################################################################################################-->

  <div class = "col-sm-6" > <!--style= "border: thin solid red;"-->
      <div id="my-tab-content" class="tab-content clearfix;">
  <!--#######################################################################################################
                                      My Utility Tab
      ######################################################################################################-->
    <div class="tab-pane active" id="about">
      <div id="intro-bkgd" style="background-color: rgb(245,245,245); padding-top: 20px; margin-left: -30px; margin-right: -25px; z-index: 0px;">
          <h4 style="margin-left: 25px;"> <strong>To learn more about your utility please:</strong></h4>
              <ul style="margin-left: 25px;">
                <li style="font-size: 14px;">(1) Select your utility from the dropdown menu above the map <em>or</em></li>
                <li style="font-size: 14px;">(2) Click on your utility in the map <em>or</em></li>
                <li style="font-size: 14px;">(3) Enter your address above to find your water service provider </li>
              </ul>
            <br>
            
            <!-- place mapbox geocoder here instead of inside the map-->
            <div class = "row" id="geocoder" style = "top: 10px; margin-left: 25px; padding-bottom: 2px;"> </div> <!-- end geocoder div-->
            <hr style="background-color: rgb(26,131,130); height: 2px; margin-left: -2px;">
      </div>
      
        
        <div id = "utilityResult" style="margin-top: 40px; margin-bottom: 20px;"> </div>
        <div id = "utilityTableHeader" style="text-align: center;"></div>
        <div id = "utilityTable" class = "table-wrapper-scroll-y my-custom-scrollbar" style="text-align: left;"></div>
    </div> <!-- end about pane-->
  
  <!--#######################################################################################################
                                      Water Supply Status Tab
      ######################################################################################################-->
    <div class="tab-pane" id="waterSupplyStatus">
      <!--Info Tab-->
       <img id="surfaceHelp" src="img/info_icon.png" style="width: 24px; height: 24px; position: absolute; right: 15px; top: 10px; z-index: 10px; cursor: pointer;">
      <div class="row" id="surface_tab_info" style="margin: 5px; display: none; z-index: 8;">
            <img src="img/surface-tab.png" style="width: 510px; height: 670px; display: inline-block;">
      </div>
       <script>
             jQuery(document).ready(function(){
                jQuery('#surfaceHelp').on('click', function(event) {
                  jQuery('#surface_tab_info').toggle('show');
                });  
              });
       </script>

     <!-- PLOTS -->
      <div class="row" id="selectDataName" style="text-align: center; padding-top: 5px;">
        <h4>Select a stream gauge or reservoir to see plot</h4>
      </div>
      <div class="row" id="selectMetadata" style="text-align: center; color: darkgray">  </div>

      <div class="row" id = "switchStatsDiv" style= "margin-left: 20px; display: none;">
        <br>
        <input type="checkbox" id="switchStats" onclick="toggleStats(this.value)">Turn stats layer on
      </div>
            
      <div class="row" id = "streamPlot" style= "margin-left: 10px;">
        <img src="img/stream_chart_icon.png" style="width: 350px; height: 350px; display: block; margin-left: auto; margin-right: auto;">
      </div>

            <!-- TABLES -->
      <div class = "row" id = "summaryTitle" style="margin: 5px; text-align: center; ">
          <h4>Recent Streamflow Conditions for Selected Utility Watersheds</h4> 
      </div>
      <div class="row" id="summaryTableDiv" style="margin-top: 0px; margin-left: 10px; margin-right: 10px; text-align: center;">
      </div>

      
      
      
    </div> <!-- end waterSupplyStatus pane-->

    <!--#######################################################################################################
                                      DEMAND Tab
      ######################################################################################################-->
    <div class="tab-pane" id="demand">
      <!-- TABLES -->
      <div class = "row" id = "demandTitle" style="margin: 5px; text-align: center; ">
          <h4>Select a utility to see water demand</h4> 
      </div>
     <!-- PLOTS -->
       <div class="row" id="selectDemandMetadata" style="text-align: center; font-size: 12px; color: darkgray">  </div>
       <div class="row" style="margin-left: 10px;">
        <div class = "col-sm-2" style="padding-top: 20px;">Select to Highlight
        <form style="color: black; font-size: 14px;">
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2002" type="checkbox"> 2002<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2007" type="checkbox"> 2007<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2010" type="checkbox"> 2010<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2011" type="checkbox"> 2011<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2012" type="checkbox"> 2012<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2013" type="checkbox"> 2013<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2014" type="checkbox"> 2014<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2015" type="checkbox"> 2015<br>
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2016" type="checkbox"> 2016<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2017" type="checkbox"> 2017<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2018" type="checkbox"> 2018<br>  
            <input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2019" type="checkbox"> 2019<br><input onclick="createTraceDemand(this.value)" name="checkDemandYear" value="2020" type="checkbox" checked> 2020<br>  
        </form>
      </div>
      <div class="col-sm-8" id = "demandPlot">
        <img src="img/demand_chart_icon.png" style="width: 350px; height: 350px; display: block; margin-left: auto; margin-right: auto;">
      </div>
    </div>
    </div> <!-- end demand pane-->


<!--#######################################################################################################
                                      GROUND WATER Tab
      ######################################################################################################-->
    <div class="tab-pane" id="groundwater">
      <!-- TABLES -->
      <div class = "row" id = "groundwaterTitle" style="margin: 5px; text-align: center; ">
          <h4>Select a well from the map for more information</h4> 
      </div>
     <!-- PLOTS -->
       <div class="row" id="selectGWMetadata" style="text-align: center; font-size: 12px; color: darkgray">  </div>

      <div class = "row" style = "margin-left: 10px;">
        <div class="col-sm-6" >
          <div class="row" style="text-align: center;"><h5>Relative Groundwater Levels</h5></div>
          <div class="row" id = "gwPlot2"></div>
        </div>

        <div class="col-sm-6">
          <div class="row" style="text-align: center;"><h5>Long-term Annual Trends</h5></div>
          <div class="row" id = "gwPlot3" style="margin-left: 2px;"></div>
        </div>
    </div>
    </div> <!-- endGroundwater pane-->


<!--#######################################################################################################
                                      PCP - DROUGHT Tab
      ######################################################################################################-->
    <div class="tab-pane" id="pcpDrought">
      <!-- TABLES -->
      <div class = "row" style="margin: 5px; text-align: center; ">
          <h4>Select a watershed to see how drought has changed over time.</h4> 
          <form name="selectSize" style="font-size: 14px; font-family: Arial; color: black;"> 
              <span><strong>Select Watershed:  </strong></span> &nbsp;
              <select style="width: 280px;" name="setHUC" id="setHUC" onchange="setHUCThis(this);">
                  <option selected = "selected" value="none"> Select from dropdown </option>
                  <optgroup label = "CAPE FEAR RIVER BASIN">
                    <option value="03030003"> Deep </option>
                    <option value="03030002"> Haw </option>
                    <option value="03030004"> Upper Cape Fear </option>
                    <option value="03030005"> Lower Cape Fear </option>
                    <option value="03030006"> Black </option>  
                    <option value="03030007"> Northeast Cape Fear </option>
                  </optgroup>
                  <optgroup label = "NEUSE RIVER BASIN">
                    <option value="03020201"> Upper Neuse </option>
                    <option value="03020202"> Middle Neuse </option>
                    <option value="03020203"> Contentnea </option>
                    <option value="03020204"> Lower Neuse </option>
                  </optgroup>
              </select>  
         </form>
         <br>
      </div>

      <div class = "row" id = "hucDroughtTitle" style="text-align: center;"><br><br></div>
      <div class = "row" id = "curDBlocks" style="border: thin solid black; margin-left: 25px; margin-right: 25px; text-align: center; display: none;">
         <div class = "col-sm-2" id = "dnonediv" style="height: 50px; font-size: 14px; padding-top: 10px;"></div>
         <div class = "col-sm-2" id = "d0div" style="padding-top: 10px; height: 50px; background-color: #FFFF00;"></div>
         <div class = "col-sm-2" id = "d1div" style="padding-top: 10px; height: 50px; background-color: #FCD37F;"></div>
         <div class = "col-sm-2" id = "d2div" style="padding-top: 10px; height: 50px; background-color: #FFAA00;"></div>
         <div class = "col-sm-2" id = "d3div" style="padding-top: 10px; height: 50px; background-color: #E60000; color: white;"></div>
         <div class = "col-sm-2" id = "d4div" style="padding-top: 10px; height: 50px; background-color: #730000; color: white;"></div>
      </div>

     <!-- PLOTS -->
      <div class="row" id = "droughtPlot" style="margin-left: 10px;"></div>
    <!-- ###################################### PCP INFORMATION -->

    <div class = "row" id = "pcpTitle" style="margin: 5px; text-align: center; ">
          <h4>Select a precipitation gauge from the map for more information</h4> 
     </div>

     <div class="row" style="margin-left: 10px;">
        <div class = "col-sm-2" style="padding-top: 20px;">Select to Highlight
        <form style="color: black; font-size: 14px;">
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2002" type="checkbox"> 2002<br>  
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2003" type="checkbox"> 2003<br>  
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2007" type="checkbox"> 2007<br>  
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2008" type="checkbox"> 2008<br>  
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2015" type="checkbox"> 2015<br>
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2016" type="checkbox"> 2016<br>  
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2017" type="checkbox"> 2017<br>  
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2018" type="checkbox"> 2018<br>  
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2019" type="checkbox" checked> 2019<br>  
            <input onclick="createTracePCP(this.value)" name="checkPCPYear" value="2020" type="checkbox" checked> 2020<br>  
        </form>
      </div>
        <div class = "row">
          <div class = "col-sm-8" id = "pcpMonthPlot"></div>
          <div class = "col-sm-8" id = "pcpCumPlot" ></div>
        </div>
    </div>

 </div> <!-- end PCP And DROUGHT pane-->

   
<!--#######################################################################################################
                                      endTabs
      ######################################################################################################-->
    </div> <!-- end my-tab-content-->
  </div> <!-- end column 6 pane-->
</div> <!-- end row-->  

<!--#######################################################################################################
                                     ADD FOOTER
      ######################################################################################################-->
<div class="row" style="color: black; font-size: 14px; background-color: rgb(230,230,230)">
    <div class="col-sm-12" id="internal_footer" style= "margin: 30px;">
        <p style="text-align: left;"> FOOTER??? Made in Partnership with...???
    </p>
    <br><br>
</div> <!--internal footer div-->  



<!--#######################################################################################################
                                    DECLARE GLOBAL VARIABLES
    ######################################################################################################-->
<script>
  // DECLARE GLOBAL VARIABLES
  var myUtility = "none";
  var myUtilityID = "none";
  var myHUC = "none";
  var currentYear = 2021;
  var clickedLayer;
  var streamLegend = document.getElementById('stream-legend');
  var recentDate;
  var streamID = "none";  var gwID = "none"; var pcpID = "none";
  var checked = ['2019','2020']; 
  var checkedDemand= ['2019'];
  var fileName;
  var streamPlotType = "off";
  
  // Create a popup, but don't add it to the map yet.
  var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
  });
 

  mapboxgl.accessToken = 'changeMe';
  var map = new mapboxgl.Map({
    container: 'map', //specify container ID
    style: 'mapbox://styles/mapbox/streets-v11', //specify map style
    center: [-78.9, 35.6], //specify the start position; long, lat
    zoom: 8
  });
  map.addControl(new mapboxgl.NavigationControl(), 'top-left');

  var geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    //limit results to NC
    bbox: [-84.321869, 33.842316, -75.460621, 36.588117],
    mapboxgl: mapboxgl,
    placeholder: "Enter address to find your utility",
    zoom: 11
   });
  document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

  var utilities;
  function getSystemData() { 
    return $.getJSON("data/triangle_systems.geojson", function(siteData){
           utilities = siteData; 
           //console.log(utilities);
           drawMap();
    });
  }
  getSystemData();    


/*-------------------------------------------------------------------------------------------------------
  ////////////    CREATE HOVER OVER MAP FUNCTIONS                                             ///////////
--------------------------------------------------------------------------------------------------------*/
 // UTILITY HOVER ----------#############################################################################
 var utilityID = null;
  map.on('mousemove', 'utilities-layer', function(e) {
      map.getCanvas().style.cursor = 'pointer';
      //check if feature exist
      if (e.features.length > 0){
        document.getElementById('map_hover_box').innerHTML = '<p><strong>Utility Information <br><br></strong>' + e.features[0].properties.utility_name + ' ('+e.features[0].properties.PWSID + ')<br>Data Available</p>';
      }// end if hover over map

      utilityID = e.features[0].id;
      if(utilityID){
        //console.log(utilityID);
        map.setFeatureState(
          {source: 'utilities', sourceLayer: 'utilities', id: utilityID}, 
          {hover: true }
        ); //end setFeatureState
      }//end if UtiltiydID
    }); //end map.on

  map.on('mouseleave', 'utilities-layer', function() {
    if (utilityID){
      map.setFeatureState({
      source: 'utilities',  id: utilityID }, 
      { hover: false   }
      );
    }
     
    utilityID = null;
    document.getElementById('map_hover_box').innerHTML = '<p>Hover over a utility</p>';
    map.getCanvas().style.cursor = ''; //resent point
   });


  map.on('mousemove', 'no-utilities-layer', function(e) {
      map.getCanvas().style.cursor = 'pointer';
      //check if feature exist
      if (e.features.length > 0){
        document.getElementById('map_hover_box').innerHTML = '<p><strong>Utility Information <br><br></strong>' + e.features[0].properties.utility_name + ' ('+e.features[0].properties.PWSID + ')<br>No Data Available</p>';
      }// end if hover over map

      utilityID = e.features[0].id;
      if(utilityID){
        map.setFeatureState(
          {source: 'utilities', sourceLayer: 'utilities', id: utilityID}, 
          {hover: true }
        ); //end setFeatureState
      }//end if UtiltiydID
    }); //end map.on

  map.on('mouseleave', 'utilities-layer', function() {
    if (utilityID){
      map.setFeatureState({
      source: 'utilities',  id: utilityID }, 
      { hover: false   }
      );
    }
     
    utilityID = null;
    document.getElementById('map_hover_box').innerHTML = '<p>Hover over a utility</p>';
    map.getCanvas().style.cursor = ''; //resent point
   });



// STREAM GAUGE HOVER ----------#############################################################################
  map.on('mousemove', 'streamgauge-layer', function(e) {
    // Change the cursor style as a UI indicator.
    map.getCanvas().style.cursor = 'pointer';
      var coordinates = e.features[0].geometry.coordinates.slice();
      var description = "<br>" + e.features[0].properties.name + " on " + e.features[0].properties.date;
     
    // Ensure that if the map is zoomed out such that multiple copies of the feature are visible, the popup appears over the copy being pointed to.
    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }
    // Populate the popup and set its coordinates based on the feature found.
    popup.setLngLat(coordinates).setHTML(description).addTo(map);
  });//end map on for stream gauges
    
  map.on('mouseleave', 'streamgauge-layer', function () {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

// RESERVOIR GAUGE HOVER ----------#############################################################################
  map.on('mousemove', 'reservoirs', function(e) {
    // Change the cursor style as a UI indicator.
    map.getCanvas().style.cursor = 'pointer';
      var coordinates = e.features[0].geometry.coordinates.slice();
      var description = e.features[0].properties.Name;
     
    // Ensure that if the map is zoomed out such that multiple copies of the feature are visible, the popup appears over the copy being pointed to.
    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }
    // Populate the popup and set its coordinates based on the feature found.
    popup.setLngLat(coordinates).setHTML(description).addTo(map);
  });//end map on for stream gauges
    
  map.on('mouseleave', 'reservoirs', function () {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });


// Groundwater HOVER ----------#############################################################################
  map.on('mousemove', 'groundwater', function(e) {
    // Change the cursor style as a UI indicator.
    map.getCanvas().style.cursor = 'pointer';
      var coordinates = e.features[0].geometry.coordinates.slice();
      var site_name = e.features[0].properties.SiteName;
      var now_date = e.features[0].properties.date;
      var aquifer = e.features[0].properties.NatAqfrDesc + " (" + e.features[0].properties.AquiferType + ")";
      var depth = e.features[0].properties.WellDepth + " feet";
      var description = site_name + ": last measured (" + now_date + ")<br>Aquifer: " + aquifer + "<br>Well Depth: " + depth;
     
    // Ensure that if the map is zoomed out such that multiple copies of the feature are visible, the popup appears over the copy being pointed to.
    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }
    // Populate the popup and set its coordinates based on the feature found.
    popup.setLngLat(coordinates).setHTML(description).addTo(map);
  });//end map on for stream gauges
    
  map.on('mouseleave', 'groundwater', function () {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });



// RESERVOIR GAUGE HOVER ----------#############################################################################
  map.on('mousemove', 'precipitation', function(e) {
    // Change the cursor style as a UI indicator.
    map.getCanvas().style.cursor = 'pointer';
      var coordinates = e.features[0].geometry.coordinates.slice();
      var now_date = e.features[0].properties.date;
      var description = e.features[0].properties.name + ": last measured (" + now_date + ")";
      
    // Ensure that if the map is zoomed out such that multiple copies of the feature are visible, the popup appears over the copy being pointed to.
    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }
    // Populate the popup and set its coordinates based on the feature found.
    popup.setLngLat(coordinates).setHTML(description).addTo(map);
  });//end map on for stream gauges
    
  map.on('mouseleave', 'precipitation', function () {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });



//########################################################################################################
 /*-------------------------------------------------------------------------------------------------------
  ////////////    CREATE CLICK ON MAP FUNCTIONS                                             ///////////
--------------------------------------------------------------------------------------------------------*/
//########################################################################################################
// set up if utilities-layer is clicked
map.on('click', 'utilities-layer', function (e){
  //since multiple overlapping layers, need to set up so that utiliteis don't get clicked when clicking on point
  var f = map.queryRenderedFeatures(e.point, {layers: ['utilities-layer','streamgauge-layer', 'reservoirs', 'groundwater', 'precipitation'] });
  //console.log(f);   console.log(f.length);
  if (f.length > 1) {return; }

  geocoder.clear();
  myUtilityID = e.features[0].properties.ncpwsid;
  myUtility = e.features[0].properties.utility_name;
  //console.log(utilityID + ": " + myUtility);

  //zoom to utility
  /*var coordinates = e.features[0].geometry.coordinates[0];
  var bounds = coordinates.reduce(function (bounds, coord) {
    return bounds.extend(coord);
  }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
  map.fitBounds(bounds, { padding: 150 });
  */

  //filter water supply watersheds?? Not sure how to do
  map.setFilter('water_supply', ['in', 'drawFile', myUtilityID]);
  map.setFilter('water_supply_name', ['in', 'drawFile', myUtilityID]);

  //run functions
  myUtilityInfo(myUtility);
  createCurrentSummary(myUtility);
  createDemandInfo(myUtilityID, checkedDemand);
  return myUtilityID;
});



map.on('click', 'streamgauge-layer', function (e){
  document.getElementById("switchStatsDiv").style.display = "block";
  
  var streamGaugeName = e.features[0].properties.name;
  streamID = e.features[0].properties.site;
  recentDate = e.features[0].properties.julian;
  var urlLink = e.features[0].properties.url_link; //console.log(e.features);
  
  //highlight in map
  if (typeof map.getLayer("streamgauge-selected") !== 'undefined') {
      map.removeLayer('streamgauge-selected');  
  }
  map.addLayer({
    'id': 'streamgauge-selected',
    'type': 'circle',
    'source': 'streamgauges',
    'filter': ['in', 'site', streamID],
    'paint': {
       'circle-radius': 20,
       'circle-color': 'yellow',
       'circle-opacity': 0.50,
    }//end paint
  });//end add layer
  
  document.getElementById("selectDataName").innerHTML = "<br><h4>" + streamID + ": <u><a style='color: rgb(26,131,130);' href=" + urlLink + " target='_blank'>" + streamGaugeName +"</a></u><h4>";
  fileName = "data/triangle_stream_stats.csv";

  createDailyStatistics(streamID, streamPlotType);
});



map.on('click', 'reservoirs', function (e){
  document.getElementById("switchStatsDiv").style.display = "block";
  var reservoirName = e.features[0].properties.Name;
  streamID = e.features[0].properties.NIDID;
  recentDate = e.features[0].properties.julian;
  var urlLink = e.features[0].properties.url_link; //console.log(e.features);

  //highlight in map
  if (typeof map.getLayer("reservoir-selected") !== 'undefined') {
      map.removeLayer('reservoir-selected');  
  }
  map.addLayer({
    'id': 'reservoir-selected',
    'type': 'circle',
    'source': 'reservoirs',
    'filter': ['in', 'NIDID', streamID],
    'paint': {
       'circle-radius': 20,
       'circle-color': 'yellow',
       'circle-opacity': 0.50,
    }//end paint
  });//end add layer


  document.getElementById("selectDataName").innerHTML = "<br><h4>" + streamID + ": <u><a style='color: rgb(26,131,130);' href=" + urlLink + " target='_blank'>" + reservoirName +"</a></u><h4>";
  fileName = "data/reservoir_stats.csv";
  createDailyStatistics(streamID, streamPlotType);
});

map.on('click', 'groundwater', function (e){
  var gwName = e.features[0].properties.SiteName;
  gwID = e.features[0].properties.site;
  recentDate = e.features[0].properties.julian;
  //var urlLink = e.features[0].properties.link; console.log(e.features);
  document.getElementById("groundwaterTitle").innerHTML = "<h4>" + e.features[0].properties.AgencyCd + " " + gwID +  gwName + "</h4>";
  createGWTab(gwID, recentDate);
});

map.on('click', 'precipitation', function (e){
  var precipName = e.features[0].properties.name;
  pcpID = e.features[0].properties.id;
  document.getElementById("pcpTitle").innerHTML = pcpID +":" + precipName + "<br>(Last reading: " + 
              e.features[0].properties.date + ")";
  plotPrecipitation(pcpID, checked);
});



/*-------------------------------------------------------------------------------------------------------
  ////////////    CREATE GEOCODER FUNCTIONS                                             ///////////
--------------------------------------------------------------------------------------------------------*/
   geocoder.on('result', function(ev) {
    var addressReturn = ev.result.center;

    //loop through utilities to see if contained
    myUtility = "none"; myUtilityID = "none";

    map.setFilter('water_supply', ['in', 'drawFile', myUtilityID]);
    map.setFilter('water_supply_name', ['in', 'drawFile', myUtilityID]);
    
    utilities.features.forEach(function(d){
      if (d3.geoContains(d, addressReturn)) {
        myUtility = d.properties.utility_name;
        myUtilityID = d.properties.ncpwsid;
      }
    }); // end forEach
    console.log(myUtility);
    //if (myUtility !== "none"){
      myUtilityInfo(myUtility);
      createCurrentSummary(myUtility);
      createDemandInfo(myUtilityID, checkedDemand);
    //}
    
  }); //end geocoder on



/*-------------------------------------------------------------------------------------------------------
  ////////////    FUNCTIONS TO DO THINGS ON MAP                                             ///////////
--------------------------------------------------------------------------------------------------------*/
//read in d3 with basic info
function myUtilityInfo(myUtility){
  //Fill in form
    var utilityText = document.getElementById("utilityResult");
    if (myUtility === "none"){ 
      map.setLayoutProperty('utilities-selected', 'visibility', 'none');

      utilityText.innerHTML = "<h4>No utility service provider found.</h4>"; 
      document.getElementById("utilityTableHeader").innerHTML = "";
      document.getElementById("utilityTable").innerHTML = "";
    }
    
    if (myUtility !== "none"){
      map.setFilter('utilities-selected', ['in', 'ncpwsid', myUtilityID]);
      map.setLayoutProperty('utilities-selected', 'visibility', 'visible');

      //try to set zoom for selected drop down
      var myFeatures = map.querySourceFeatures('utilities', {
        sourceLayer: 'utilites',
        filter: ["in", "ncpwsid", myUtilityID]
    });
      //zoom to utility
    var coordinates = myFeatures[0].geometry.coordinates[0];
    var bounds = coordinates.reduce(function (bounds, coord) {
                return bounds.extend(coord);
                  }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
                map.fitBounds(bounds, { padding: 200 });
    
      
     //load data 
     d3.csv("data/basic_info.csv").then(function(dataCSV){
     var selectData = dataCSV.filter(function(d) {return d.utility_name === myUtility; });
     //console.log(dataCSV); console.log(selectData);
     var myUtilityWebsite = selectData[0].utility_website; 
     //var myUtilityDrought = selectData[0].drought_status;
     var myUtilityWaterPlan = selectData[0].water_shortage_plans;
     var myUtilityUpdatePlan = selectData[0].last_update;
     var myUtilityStage = selectData[0].stage;
            
     utilityText.innerHTML = "<h4 style = 'color:rgb(26,131,130);'>You are located in the <u><a style='color:rgb(252,67,57);' href = " + myUtilityWebsite + " target='_blank'>" + myUtility + "</a></u> service area.</h4>" + 
      "<p style='font-size:16px/'> My Water Conservation Status is: <span style='background-color: yellow;'>" + myUtilityStage + " (MADE UP NOW)</span><br>" + 
      "To learn more about my utility's water conservation plan, click <a style='color:rgb(252,67,57);' href = " + myUtilityWaterPlan + " target='_blank'><u>here</u></a>. <br>This plan was last updated in " + myUtilityUpdatePlan + ".</p>";


    //create table for utility conservation status
    document.getElementById("utilityTableHeader").innerHTML = "<h4>"+ myUtility + " Water Conservation Activities</h4>";

    //read in data
    d3.csv("data/water_shortage_responses.csv").then(function(shortCSV){
      shortSelect = shortCSV.filter(function(d){return d.utility_name === myUtility; });
      
     //create table --- scroll options on table height, etc are in the css portion
    var myUtilityTable = "<table class='table table-bordered table-striped' style='font-size: 12px; text-align: left;'>";
    
    //create column header
    myUtilityTable += "<thead><tr>";
    myUtilityTable += "<th>Activity</th>";
    var tableHeaders = shortSelect.map(function(d){ return d.stage; });
    tableHeaders = Array.from(new Set(tableHeaders));
    var columnNumber;
   
   //loop through and add headers based on number of stages
    for (var i = 0, len = tableHeaders.length; i < len; i++) {
      if (tableHeaders[i] === myUtilityStage){
        myUtilityTable += "<th style = 'background-color: #edca6b; border thick solid #b98d16;'>" + tableHeaders[i] + "</th>";
        columnNumber = i;
      }
      else {myUtilityTable += "<th>" + tableHeaders[i] + "</th>";}
    }
   
   //end header and start body to loop through by activity
    myUtilityTable += "</thead><tbody'>";
    var activity = shortSelect.map(function(d) { return d.activity; });
    activity = Array.from(new Set(activity)); //returns unique value

    var activityResponse = [];
  //loop through and add headers based on number of stages
    for (i = 0, len = activity.length; i < len; i++) {
      myUtilityTable += "<tr>";
      myUtilityTable += "<td>" + activity[i] + "</td>";

      //fill in response
      activityResponse = shortSelect.filter(function(d) {return d.activity === activity[i]; }).map(function(m) { return m.stage_response; });

      for (var j = 0, len2 = activityResponse.length; j < len2; j++){
        if (j === columnNumber){
            myUtilityTable += "<td style = 'background-color: #edca6b; border thick solid #b98d16;'>" + activityResponse[j] + "</td>";
        }
        else { myUtilityTable += "<td>" + activityResponse[j] + "</td>";}
      }
      myUtilityTable += "</tr>";
    }

    myUtilityTable += "</tbody></table><br><br>"; 

  //load table
  document.getElementById("utilityTable").innerHTML = myUtilityTable;

        }); //end d3 water shortage
      }); //end d3 basic info
  }// end if a utility is selected
    
return myUtility;
} //end myUtilityInfo function


$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    target=$(e.target).attr("href");
    var visibility;

  if(target=="#waterSupplyStatus")  { 
    visibility = map.getLayoutProperty('streamgauge-layer', 'visibility');
    if (visibility === "none") {
      document.getElementById('menuStreamGages').click();
    }

    visibility = map.getLayoutProperty('water_supply', 'visibility');
    if (visibility === "none") {
      document.getElementById('menuSource').click();
    }
    
    /*visibility = map.getLayoutProperty('reservoirs', 'visibility');
    if (visibility === "none") {
      document.getElementById('menuReservoirs').click();
    }*/
  }

  if(target=="#demand"){
    createDemandInfo(myUtilityID, checkedDemand);
  }

  if(target=="#groundwater"){
    visibility = map.getLayoutProperty('groundwater', 'visibility');
    if (visibility === "none") {
      document.getElementById('menuGroundwater').click();
    }
    if (gwID !== "none"){
      createGWTab(gwID, recentDate);
    }
  }

  if(target=="#pcpDrought"){
    visibility = map.getLayoutProperty('precipitation', 'visibility');
    if (visibility === "none") {
      document.getElementById('menuPrecipitation').click();
    }
    
  }
});



</script>

<script type="text/javascript" src="scripts/drawMap.js"></script>
<script type="text/javascript" src="scripts/stream_stats.js"></script>
<script type="text/javascript" src="scripts/demandTab.js"></script>
<script type="text/javascript" src="scripts/groundwaterTab.js"></script>
<script type="text/javascript" src="scripts/droughtPlot.js"></script>
<script type="text/javascript" src="scripts/precipPlots.js"></script>
    </body>
</html>



